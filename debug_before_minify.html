<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simplified JSON Browser</title>
<style>* { box-sizing: border-box; }
body { 
  font-family: 'Consolas', monospace; 
  margin: 0; 
  padding: 20px;
  background: #f8f9fa;
  overflow: hidden; 
}

.header { 
  position: sticky; 
  top: 0;
  background: #fff;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-bottom: 20px;
  display: flex;
  gap: 15px;
  align-items: center;
  flex-wrap: wrap;
  z-index: 200; 
}

.search-box {
  flex: 1;
  min-width: 200px;
  padding: 8px 12px;
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
}

.search-box:focus {
  outline: none;
  border-color: #007bff;
}

.controls button, .search-nav button {
  padding: 8px 16px;
  margin: 0 4px;
  border: none;
  border-radius: 6px;
  background: #007bff;
  color: white;
  cursor: pointer;
  font-size: 12px;
}

.controls button:hover, .search-nav button:hover {
  background: #0056b3;
}

.controls button.active {
  background: #28a745;
}

.search-nav button {
  width: 32px;
  height: 32px;
  padding: 0;
}

.search-nav button:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.search-info {
  font-size: 12px;
  color: #666;
  white-space: nowrap;
}

.hidden-indicator {
  color: #dc3545;
  font-size: 11px;
  margin-left: 8px;
}

/* Scrollable viewport for the main table */
.json-table { 
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  max-height: calc(100vh - 140px); 
  overflow-y: auto; 
  overflow-x: auto; /* <<<< THIS IS KEY */
  width: 100%;      /* Take up available width of its parent */
}

/* The main data table inside .json-table */
.json-table > table {
  width: auto; /* Allow table to be wider than its container if content demands */
  min-width: 100%; /* But at least as wide as its container initially */
  border-collapse: collapse;
  table-layout: auto; 
}

/* Main table header and data cells */
.json-table > table > thead > tr > th,
.json-table > table > tbody > tr > td {
  padding: 10px 12px; 
  text-align: left;
  border-bottom: 1px solid #eee;
  font-size: 13px;
  
  min-width: 150px;   

  word-wrap: break-word; 
  overflow-wrap: break-word; 
  vertical-align: top;
}

/* Main table header cells */
.json-table > table > thead > tr > th {
  background: #f8f9fa;
  font-weight: 600;
  cursor: pointer;
  user-select: none;
  position: sticky; 
  top: 0; 
  z-index: 100; 
  white-space: nowrap; 
}

.json-table > table > thead > tr > th:hover {
  background: #e9ecef;
}

.json-table > table > thead > tr > th.sorted::after {
  content: ' ↓';
  color: #007bff;
}

.json-table > table > thead > tr > th.sorted.asc::after {
  content: ' ↑';
}

.json-table > table > tbody > tr:nth-child(even) {
  background: #f8f9fa;
}

.json-table > table > tbody > tr:hover {
  background: #e3f2fd;
}

.expandable {
  cursor: pointer;
  position: relative;
  background: linear-gradient(135deg, #fff3e0, #fff8e1);
  border-left: 3px solid #ff9800;
  padding: 4px 8px; 
  border-radius: 4px; 
  display: inline-block; 
  max-width: 100%; 
}

.expandable:hover {
  background: linear-gradient(135deg, #ffe0b2, #ffecb3);
}

.toggle {
  display: inline-block;
  width: 20px;
  text-align: center;
  font-weight: bold;
  color: #007bff;
  margin-right: 8px;
}

.nested {
  max-height: 0;
  overflow: hidden; 
  transition: max-height 0.3s ease, padding 0.3s ease, margin 0.3s ease;
  background: #f0f8ff; 
  border-left: 2px solid #007bff;
  margin: 0; 
  padding: 0; 
  border-radius: 4px;
}

.nested.expanded {
  max-height: 5000px; 
  padding: 8px 12px;
  margin: 8px 0 4px 20px; 
  overflow-y: auto; 
}

.nested-table {
  font-size: 11px;
  margin: 4px 0; 
  width: max-content; 
  min-width: 100%;   
  table-layout: auto; 
}

.nested-table th,
.nested-table td {
  padding: 6px 8px;
  border-bottom: 1px solid #ddd;
  font-size: 12px; 
  min-width: 100px; 
  word-wrap: break-word;
  overflow-wrap: break-word;
  vertical-align: top;
  white-space: nowrap; 
}

.nested-table th {
  background: #e9ecef; 
  position: sticky; 
  top: 0; 
  z-index: 50; 
  white-space: nowrap;
}

.nested-table td.row-number { 
      text-align: center;
      font-weight: normal; 
      background: #f7f7f7; 
}

.highlight {
  background: #ffeb3b;
  padding: 1px 2px;
  border-radius: 2px;
  font-weight: bold;
}

.highlight.current {
  background: #ff5722;
  color: white;
  box-shadow: 0 0 4px rgba(255, 87, 34, 0.5);
}

.path-display {
  font-size: 10px;
  color: #666;
  margin-top: 2px;
  font-style: italic;
  word-break: break-all; 
}

.row-number { 
  text-align: center;
  width: 50px !important;     
  min-width: 50px !important;  
  max-width: 50px !important;  
  position: sticky;
  left: 0;
  overflow: hidden; 
  text-overflow: ellipsis;
  white-space: normal; 
}
.json-table > table > tbody > tr > td.row-number {
  font-weight: 600;
  color: #495057;
  background: #f8f9fa; 
  z-index: 90; 
}
.json-table > table > tbody > tr:nth-child(even) > td.row-number {
  background: #e9ecef; 
}
.json-table > table > thead > tr > th.row-number {
  font-weight: 600;
  color: #495057;
  background: #f8f9fa; 
  z-index: 150; 
}

.loading {
  text-align: center;
  padding: 40px;
  color: #666;
}

.no-results {
  text-align: center;
  padding: 40px;
  color: #999;
  font-style: italic;
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000; 
}

.modal-content {
  background: white;
  border-radius: 8px;
  padding: 20px;
  max-width: 90%;
  max-height: 90%;
  overflow: auto;
  position: relative;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  border-bottom: 1px solid #eee;
  padding-bottom: 15px;
}

.close-btn {
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 8px 12px;
  cursor: pointer;
}

/* Removed .column-selector, .column-list, .column-item, .active-column, .move-btns styles */



.promote-btn {
    margin-left: 8px; 
    padding: 1px 5px; 
    font-size: 11px;
    line-height: 1.2;
    font-weight: bold;
    cursor: pointer;
    background-color: #28a745; 
    color: white;
    border: none;
    border-radius: 4px;
    vertical-align: middle; 
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  
  .promote-btn:hover {
    background-color: #218838; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
  }
  
  .controls button.active {
    background: #28a745; 
  }
  
  .remove-col-btn-header {
    margin-left: 5px;
    padding: 0px 4px;
    font-size: 10px;
    line-height: 1;
    font-weight: bold;
    cursor: pointer;
    background-color: #dc3545; /* Red for removal */
    color: white;
    border: none;
    border-radius: 3px;
    vertical-align: middle;
  }
  
  .remove-col-btn-header:hover {
    background-color: #c82333; /* Darker red */
  }
  
  .json-table > table > thead > tr > th > div {
    display: flex;
    align-items: center; 
    justify-content: space-between; 
  }

.sql-output, .json-edit-output { /* Grouped for common properties */
    width: 100%;
    font-family: 'Consolas', monospace;
    font-size: 12px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #f8f9fa;
    /* resize: vertical; Replaced by flexbox for json-edit-output */
  }
  
  .sql-output {
    min-height: 300px;
    resize: vertical;
  }
  
  .json-edit-output {
    /* flex-grow: 1; /* Set by inline style */
    /* resize: none; /* Set by inline style */
    /* Specific min-height if not using flex effectively, but flex is preferred */
  }
  
  /* Ensure modal content can scroll if textarea becomes too large (though resize is none) */
  .modal-content {
    /* ... existing styles ... */
    overflow: auto; /* This was already there, good. */
  }

  </style>
  
</head>
<body>
  <div id="app">
    <div class="loading">Loading JSON data...</div>
  </div>

  <script>const jsonData = [{"id":"1a","event_time":"2023-03-21 20:11:52.123042 +00:00","event_name":"StopInstances","aws_region":"us-west-2","source_ip":"96.2.2.91","username":"isrjlypi","instance_id":"i-442458b2","principal_id":"AIDVAPHSPDMRWFT","trace_id":"d9f1a992-fcb0-4c81-b59b-0ad7bcfc22f3","raw_event":{"eventVersion":"1.08","userIdentity":{"type":"IAMUser","principalId":"AIDVAPHSPDMRWFT","arn":"arn:aws:iam::123456789012:user/isrjlypi","accountId":"123456789012","userName":"isrjlypi","sessionContext":{"attributes":{"mfaAuthenticated":"false","creationDate":"2023-05-28T20:11:52.123009Z"},"sessionIssuer":{"type":"Role","principalId":"AIDSTVURSUGUEWR","arn":"arn:aws:iam::123456789012:role/yxvaezuz","accountId":"123456789012","userName":"yxvaezuz"}}},"eventTime":"2023-03-21T20:11:52.123042Z","eventSource":"ec2.amazonaws.com","eventName":"StopInstances","awsRegion":"us-west-2","sourceIPAddress":"96.2.2.91","requestParameters":{"instancesSet":{"items":[{"instanceId":"i-442458b2"}]},"dryRun":false,"tags":[{"key":"Environment","value":"Dev"},{"key":"Owner","value":"isrjlypi"},{"key":"Project","value":"ntdgykeo"},{"key":"CostCenter","value":"6989"}],"extraDetails":{"config":{"setting1":true,"setting2":"value","setting3":["ujipcnmy","flbroiyt","ukwqxjcl"],"nestedLevel1":{"nestedLevel2":{"nestedLevel3":{"nestedLevel4":{"finalLevel":{"uid":"02c74d6f-0465-4def-ad66-8d3e27edff38","flags":{"enabled":true,"rate":38.92},"timestamps":{"created":"2024-02-10T20:11:52.123165Z","updated":"2023-03-08T20:11:52.123172Z"}}}}}}}}},"responseElements":{"instancesSet":{"items":[{"instanceId":"i-442458b2","currentState":{"code":16,"name":"running"},"previousState":{"code":80,"name":"stopped"},"status":{"checkTime":"2025-01-02T20:11:52.123178Z","metrics":{"cpu":4,"disk":{"used":119,"total":500,"iops":895},"network":{"in":3635,"out":2266}}}}]}},"resources":[{"ARN":"arn:aws:ec2:us-east-1::instance/i-442458b2","type":"AWS::EC2::Instance"}],"debugInfo":{"traceId":"d9f1a992-fcb0-4c81-b59b-0ad7bcfc22f3","flags":{"beta":false,"test":false},"extra":{"depth1":{"depth2":{"depth3":{"depth4":{"depth5":{"depth6":{"flag":true,"payload":{"numbers":[78,64,1,88,20],"nestedArray":[["bvzsncrc","icemkagc"],["zjordoft","tpkojlsa"],["pphfqifo","avbsroyf"]],"timestamp":"2023-12-16T20:11:52.123228Z"}}}}}}}}}}},{"id":2,"event_time":"2023-03-16 20:11:52.123400 +00:00","event_name":"RebootInstances","aws_region":"us-east-1","source_ip":"59.15.181.63","username":"tcdjmqxc","instance_id":"i-13e728a6","principal_id":"AIDULHHCBTGJCEX","trace_id":"c5026268-f271-4520-92c5-e37351ba1014","raw_event":{"eventVersion":"1.08","userIdentity":{"type":"IAMUser","principalId":"AIDULHHCBTGJCEX","arn":"arn:aws:iam::123456789012:user/tcdjmqxc","accountId":"123456789012","userName":"tcdjmqxc","sessionContext":{"attributes":{"mfaAuthenticated":"true","creationDate":"2022-07-20T20:11:52.123390Z"},"sessionIssuer":{"type":"Role","principalId":"AIDOEHPKJUXRBPL","arn":"arn:aws:iam::123456789012:role/xtesvrun","accountId":"123456789012","userName":"xtesvrun"}}},"eventTime":"2023-03-16T20:11:52.123400Z","eventSource":"ec2.amazonaws.com","eventName":"RebootInstances","awsRegion":"us-east-1","sourceIPAddress":"59.15.181.63","requestParameters":{"instancesSet":{"items":[{"instanceId":"i-13e728a6"}]},"dryRun":false,"tags":[{"key":"Environment","value":"Dev"},{"key":"Owner","value":"tcdjmqxc"},{"key":"Project","value":"oydetzlo"},{"key":"CostCenter","value":"9356"}],"extraDetails":{"config":{"setting1":true,"setting2":"value","setting3":["lquxpoyw","iyqwnkta","mraevsap"],"nestedLevel1":{"nestedLevel2":{"nestedLevel3":{"nestedLevel4":{"finalLevel":{"uid":"866ed7b4-8947-4b3f-a339-ed7175896ee0","flags":{"enabled":false,"rate":56.35},"timestamps":{"created":"2023-03-20T20:11:52.123466Z","updated":"2025-01-02T20:11:52.123471Z"}}}}}}}}},"responseElements":{"instancesSet":{"items":[{"instanceId":"i-13e728a6","currentState":{"code":16,"name":"running"},"previousState":{"code":80,"name":"stopped"},"status":{"checkTime":"2023-01-15T20:11:52.123476Z","metrics":{"cpu":45,"disk":{"used":74,"total":500,"iops":349},"network":{"in":2113,"out":2145}}}}]}},"resources":[{"ARN":"arn:aws:ec2:us-west-2::instance/i-13e728a6","type":"AWS::EC2::Instance"}],"debugInfo":{"traceId":"c5026268-f271-4520-92c5-e37351ba1014","flags":{"beta":true,"test":true},"extra":{"depth1":{"depth2":{"depth3":{"depth4":{"depth5":{"depth6":{"flag":true,"payload":{"numbers":[92,96,2,93,15],"nestedArray":[["micpcfrb","orzoszwq"],["juqkxawu","viwezmto"],["nybekyak","rsgsllrl"]],"timestamp":"2024-07-25T20:11:52.123507Z"}}}}}}}}}}},{"id":3,"event_time":"2022-10-14 20:11:52.123749 +00:00","event_name":"StartInstances","aws_region":"us-east-1","source_ip":"5.193.233.162","username":"hkyzutzz","instance_id":"i-9fef0e60","principal_id":"AIDWUZSKEIMXNHX","trace_id":"75d98fdc-1986-43ee-a1c7-f4af114e4094","raw_event":{"eventVersion":"1.08","userIdentity":{"type":"IAMUser","principalId":"AIDWUZSKEIMXNHX","arn":"arn:aws:iam::123456789012:user/hkyzutzz","accountId":"123456789012","userName":"hkyzutzz","sessionContext":{"attributes":{"mfaAuthenticated":"false","creationDate":"2023-06-25T20:11:52.123738Z"},"sessionIssuer":{"type":"Role","principalId":"AIDDWDIJCFICEWJ","arn":"arn:aws:iam::123456789012:role/kmjfurzi","accountId":"123456789012","userName":"kmjfurzi"}}},"eventTime":"2022-10-14T20:11:52.123749Z","eventSource":"ec2.amazonaws.com","eventName":"StartInstances","awsRegion":"us-east-1","sourceIPAddress":"5.193.233.162","requestParameters":{"instancesSet":{"items":[{"instanceId":"i-9fef0e60"}]},"dryRun":true,"tags":[{"key":"Environment","value":"Test"},{"key":"Owner","value":"hkyzutzz"},{"key":"Project","value":"bpkulscd"},{"key":"CostCenter","value":"4977"}],"extraDetails":{"config":{"setting1":true,"setting2":"value","setting3":["gsjggsyv","mvcmzwbx","sultenmt"],"nestedLevel1":{"nestedLevel2":{"nestedLevel3":{"nestedLevel4":{"finalLevel":{"uid":"013b3ad3-ff9f-49c0-aa9f-79ac838a4e35","flags":{"enabled":true,"rate":6.04},"timestamps":{"created":"2024-10-13T20:11:52.123838Z","updated":"2025-01-07T20:11:52.123845Z"}}}}}}}}},"responseElements":{"instancesSet":{"items":[{"instanceId":"i-9fef0e60","currentState":{"code":16,"name":"running"},"previousState":{"code":80,"name":"stopped"},"status":{"checkTime":"2022-12-08T20:11:52.123853Z","metrics":{"cpu":1,"disk":{"used":69,"total":500,"iops":580},"network":{"in":2879,"out":2435}}}}]}},"resources":[{"ARN":"arn:aws:ec2:us-west-2::instance/i-9fef0e60","type":"AWS::EC2::Instance"}],"debugInfo":{"traceId":"75d98fdc-1986-43ee-a1c7-f4af114e4094","flags":{"beta":false,"test":true},"extra":{"depth1":{"depth2":{"depth3":{"depth4":{"depth5":{"depth6":{"flag":false,"payload":{"numbers":[8,20,16,60,32],"nestedArray":[["nerxvqmk","emvhilch"],["jaxraeuu","hcgnwazo"],["agiurybw","nivoealm"]],"timestamp":"2024-02-28T20:11:52.123907Z"}}}}}}}}}}},{"id":4,"event_time":"2024-01-23 20:11:52.124057 +00:00","event_name":"StartInstances","aws_region":"eu-west-1","source_ip":"235.9.42.34","username":"kgodpmso","instance_id":"i-f901eb58","principal_id":"AIDRYTNDADZBKTT","trace_id":"decb3350-236b-4e82-ac85-47895a43c39d","raw_event":{"eventVersion":"1.08","userIdentity":{"type":"IAMUser","principalId":"AIDRYTNDADZBKTT","arn":"arn:aws:iam::123456789012:user/kgodpmso","accountId":"123456789012","userName":"kgodpmso","sessionContext":{"attributes":{"mfaAuthenticated":"false","creationDate":"2025-02-08T20:11:52.124043Z"},"sessionIssuer":{"type":"Role","principalId":"AIDQAYSBGIKSEGI","arn":"arn:aws:iam::123456789012:role/dbajyuis","accountId":"123456789012","userName":"dbajyuis"}}},"eventTime":"2024-01-23T20:11:52.124057Z","eventSource":"ec2.amazonaws.com","eventName":"StartInstances","awsRegion":"eu-west-1","sourceIPAddress":"235.9.42.34","requestParameters":{"instancesSet":{"items":[{"instanceId":"i-f901eb58"}]},"dryRun":true,"tags":[{"key":"Environment","value":"Test"},{"key":"Owner","value":"kgodpmso"},{"key":"Project","value":"rrrzjwkk"},{"key":"CostCenter","value":"9168"}],"extraDetails":{"config":{"setting1":true,"setting2":"value","setting3":["ujswysza","bfrmpqjz","zxcfhobr"],"nestedLevel1":{"nestedLevel2":{"nestedLevel3":{"nestedLevel4":{"finalLevel":{"uid":"ce490e6f-f5f2-44b6-9c5d-1f13ca17e558","flags":{"enabled":true,"rate":57.87},"timestamps":{"created":"2025-01-25T20:11:52.124123Z","updated":"2023-12-30T20:11:52.124128Z"}}}}}}}}},"responseElements":{"instancesSet":{"items":[{"instanceId":"i-f901eb58","currentState":{"code":16,"name":"running"},"previousState":{"code":80,"name":"stopped"},"status":{"checkTime":"2023-07-05T20:11:52.124135Z","metrics":{"cpu":45,"disk":{"used":318,"total":500,"iops":106},"network":{"in":2053,"out":4138}}}}]}},"resources":[{"ARN":"arn:aws:ec2:us-east-1::instance/i-f901eb58","type":"AWS::EC2::Instance"}],"debugInfo":{"traceId":"decb3350-236b-4e82-ac85-47895a43c39d","flags":{"beta":false,"test":false},"extra":{"depth1":{"depth2":{"depth3":{"depth4":{"depth5":{"depth6":{"flag":true,"payload":{"numbers":[75,8,22,81,49],"nestedArray":[["nzpqmtzw","sqiwjxls"],["xcxefvdg","xuhmwocr"],["hedsfalv","vcoewqtt"]],"timestamp":"2023-12-19T20:11:52.124173Z"}}}}}}}}}}},{"id":5,"event_time":"2023-07-07 20:11:52.124339 +00:00","event_name":"RebootInstances","aws_region":"us-east-1","source_ip":"12.153.22.179","username":"kxyfphko","instance_id":"i-875dd5cb","principal_id":"AIDYVMVTJCQUZKQ","trace_id":"45e3ee03-0e55-46cb-8b1f-174118b3ba42","raw_event":{"eventVersion":"1.08","userIdentity":{"type":"IAMUser","principalId":"AIDYVMVTJCQUZKQ","arn":"arn:aws:iam::123456789012:user/kxyfphko","accountId":"123456789012","userName":"kxyfphko","sessionContext":{"attributes":{"mfaAuthenticated":"true","creationDate":"2024-07-02T20:11:52.124323Z"},"sessionIssuer":{"type":"Role","principalId":"AIDUMIHTCLNXGJI","arn":"arn:aws:iam::123456789012:role/hwjcyipp","accountId":"123456789012","userName":"hwjcyipp"}}},"eventTime":"2023-07-07T20:11:52.124339Z","eventSource":"ec2.amazonaws.com","eventName":"RebootInstances","awsRegion":"us-east-1","sourceIPAddress":"12.153.22.179","requestParameters":{"instancesSet":{"items":[{"instanceId":"i-875dd5cb"}]},"dryRun":true,"tags":[{"key":"Environment","value":"Prod"},{"key":"Owner","value":"kxyfphko"},{"key":"Project","value":"kkvlcmck"},{"key":"CostCenter","value":"4389"}],"extraDetails":{"config":{"setting1":true,"setting2":"value","setting3":["aicusgvf","qnxfnuwx","hxnpfdyj"],"nestedLevel1":{"nestedLevel2":{"nestedLevel3":{"nestedLevel4":{"finalLevel":{"uid":"f403aa25-0ccc-4316-a3dd-63ede29f4b02","flags":{"enabled":true,"rate":88.8},"timestamps":{"created":"2022-11-01T20:11:52.124388Z","updated":"2023-06-25T20:11:52.124392Z"}}}}}}}}},"responseElements":{"instancesSet":{"items":[{"instanceId":"i-875dd5cb","currentState":{"code":16,"name":"running"},"previousState":{"code":80,"name":"stopped"},"status":{"checkTime":"2024-03-16T20:11:52.124397Z","metrics":{"cpu":47,"disk":{"used":178,"total":500,"iops":687},"network":{"in":4825,"out":1442}}}}]}},"resources":[{"ARN":"arn:aws:ec2:us-west-2::instance/i-875dd5cb","type":"AWS::EC2::Instance"}],"debugInfo":{"traceId":"45e3ee03-0e55-46cb-8b1f-174118b3ba42","flags":{"beta":true,"test":true},"extra":{"depth1":{"depth2":{"depth3":{"depth4":{"depth5":{"depth6":{"flag":false,"payload":{"numbers":[97,78,80,58,14],"nestedArray":[["siskrtnv","aogmnijy"],["fccquqpf","xvalwvfh"],["shnwwyxc","ttoenkpp"]],"timestamp":"2025-03-28T20:11:52.124437Z"}}}}}}}}}}},{"id":6,"event_time":"2022-10-03 20:11:52.124560 +00:00","event_name":"RebootInstances","aws_region":"eu-west-1","source_ip":"164.56.172.134","username":"hiakglgt","instance_id":"i-6829314a","principal_id":"AIDYZUNDZHOMRNW","trace_id":"8ff5daa7-cb91-4546-8b97-41e90ca875e9","raw_event":{"eventVersion":"1.08","userIdentity":{"type":"IAMUser","principalId":"AIDYZUNDZHOMRNW","arn":"arn:aws:iam::123456789012:user/hiakglgt","accountId":"123456789012","userName":"hiakglgt","sessionContext":{"attributes":{"mfaAuthenticated":"true","creationDate":"2022-07-22T20:11:52.124551Z"},"sessionIssuer":{"type":"Role","principalId":"AIDLQSQJRMPLRIZ","arn":"arn:aws:iam::123456789012:role/gicjppcx","accountId":"123456789012","userName":"gicjppcx"}}},"eventTime":"2022-10-03T20:11:52.124560Z","eventSource":"ec2.amazonaws.com","eventName":"RebootInstances","awsRegion":"eu-west-1","sourceIPAddress":"164.56.172.134","requestParameters":{"instancesSet":{"items":[{"instanceId":"i-6829314a"}]},"dryRun":true,"tags":[{"key":"Environment","value":"Test"},{"key":"Owner","value":"hiakglgt"},{"key":"Project","value":"nffvgrpi"},{"key":"CostCenter","value":"7318"}],"extraDetails":{"config":{"setting1":true,"setting2":"value","setting3":["lceiwzuf","hcbfrkim","sbpzysxg"],"nestedLevel1":{"nestedLevel2":{"nestedLevel3":{"nestedLevel4":{"finalLevel":{"uid":"d4c90ae5-c807-4b75-bb4e-c776762cec50","flags":{"enabled":true,"rate":17.96},"timestamps":{"created":"2022-09-03T20:11:52.124626Z","updated":"2025-03-09T20:11:52.124630Z"}}}}}}}}},"responseElements":{"instancesSet":{"items":[{"instanceId":"i-6829314a","currentState":{"code":16,"name":"running"},"previousState":{"code":80,"name":"stopped"},"status":{"checkTime":"2022-10-12T20:11:52.124635Z","metrics":{"cpu":49,"disk":{"used":374,"total":500,"iops":410},"network":{"in":2674,"out":2145}}}}]}},"resources":[{"ARN":"arn:aws:ec2:us-west-2::instance/i-6829314a","type":"AWS::EC2::Instance"}],"debugInfo":{"traceId":"8ff5daa7-cb91-4546-8b97-41e90ca875e9","flags":{"beta":true,"test":true},"extra":{"depth1":{"depth2":{"depth3":{"depth4":{"depth5":{"depth6":{"flag":false,"payload":{"numbers":[7,10,58,71,2],"nestedArray":[["verpnegm","kmxgcqiz"],["uyqazzqb","elbykbki"],["ceadhejr","ihkdiaol"]],"timestamp":"2024-01-10T20:11:52.124675Z"}}}}}}}}}}},{"id":7,"event_time":"2024-04-04 20:11:52.124808 +00:00","event_name":"StartInstances","aws_region":"us-east-1","source_ip":"109.115.234.34","username":"qgyctais","instance_id":"i-52b9b187","principal_id":"AIDATEMOQAUXMHO","trace_id":"ffe4bb33-cd0e-4d48-b5f7-567ca3bf3a26","raw_event":{"eventVersion":"1.08","userIdentity":{"type":"IAMUser","principalId":"AIDATEMOQAUXMHO","arn":"arn:aws:iam::123456789012:user/qgyctais","accountId":"123456789012","userName":"qgyctais","sessionContext":{"attributes":{"mfaAuthenticated":"false","creationDate":"2023-04-15T20:11:52.124799Z"},"sessionIssuer":{"type":"Role","principalId":"AIDYPZZAKDGZINA","arn":"arn:aws:iam::123456789012:role/utguppxw","accountId":"123456789012","userName":"utguppxw"}}},"eventTime":"2024-04-04T20:11:52.124808Z","eventSource":"ec2.amazonaws.com","eventName":"StartInstances","awsRegion":"us-east-1","sourceIPAddress":"109.115.234.34","requestParameters":{"instancesSet":{"items":[{"instanceId":"i-52b9b187"}]},"dryRun":true,"tags":[{"key":"Environment","value":"Test"},{"key":"Owner","value":"qgyctais"},{"key":"Project","value":"ejaeaxlv"},{"key":"CostCenter","value":"8113"}],"extraDetails":{"config":{"setting1":true,"setting2":"value","setting3":["ulsueqyq","olsbkslv","aiiwvcfb"],"nestedLevel1":{"nestedLevel2":{"nestedLevel3":{"nestedLevel4":{"finalLevel":{"uid":"b77f9d46-822a-43b4-9ae9-c564843524c6","flags":{"enabled":true,"rate":21.52},"timestamps":{"created":"2023-04-03T20:11:52.124872Z","updated":"2024-08-28T20:11:52.124877Z"}}}}}}}}},"responseElements":{"instancesSet":{"items":[{"instanceId":"i-52b9b187","currentState":{"code":16,"name":"running"},"previousState":{"code":80,"name":"stopped"},"status":{"checkTime":"2024-07-08T20:11:52.124944Z","metrics":{"cpu":75,"disk":{"used":45,"total":500,"iops":756},"network":{"in":4244,"out":2860}}}}]}},"resources":[{"ARN":"arn:aws:ec2:us-east-1::instance/i-52b9b187","type":"AWS::EC2::Instance"}],"debugInfo":{"traceId":"ffe4bb33-cd0e-4d48-b5f7-567ca3bf3a26","flags":{"beta":true,"test":false},"extra":{"depth1":{"depth2":{"depth3":{"depth4":{"depth5":{"depth6":{"flag":false,"payload":{"numbers":[1,54,44,29,57],"nestedArray":[["rkrmshka","flzxgoui"],["xbygylwi","cxvszzjo"],["aiwbjdaq","oizwzpyq"]],"timestamp":"2024-05-23T20:11:52.124996Z"}}}}}}}}}}},{"id":8,"event_time":"2024-01-03 20:11:52.125173 +00:00","event_name":"RebootInstances","aws_region":"eu-west-1","source_ip":"86.198.24.167","username":"hcnepmyc","instance_id":"i-0e2bd482","principal_id":"AIDLVEURORHVXKE","trace_id":"7a785fce-8e60-41c8-a5a9-fd21a3435f49","raw_event":{"eventVersion":"1.08","userIdentity":{"type":"IAMUser","principalId":"AIDLVEURORHVXKE","arn":"arn:aws:iam::123456789012:user/hcnepmyc","accountId":"123456789012","userName":"hcnepmyc","sessionContext":{"attributes":{"mfaAuthenticated":"true","creationDate":"2024-12-28T20:11:52.125161Z"},"sessionIssuer":{"type":"Role","principalId":"AIDRSKNAIYDMAGE","arn":"arn:aws:iam::123456789012:role/dozbgmlo","accountId":"123456789012","userName":"dozbgmlo"}}},"eventTime":"2024-01-03T20:11:52.125173Z","eventSource":"ec2.amazonaws.com","eventName":"RebootInstances","awsRegion":"eu-west-1","sourceIPAddress":"86.198.24.167","requestParameters":{"instancesSet":{"items":[{"instanceId":"i-0e2bd482"}]},"dryRun":false,"tags":[{"key":"Environment","value":"Prod"},{"key":"Owner","value":"hcnepmyc"},{"key":"Project","value":"rgyiemhz"},{"key":"CostCenter","value":"5586"}],"extraDetails":{"config":{"setting1":true,"setting2":"value","setting3":["vjhvpffl","mmhoecox","ljsfqgqe"],"nestedLevel1":{"nestedLevel2":{"nestedLevel3":{"nestedLevel4":{"finalLevel":{"uid":"9a6ee963-21dd-4cc1-b81d-b0cdeb8d7737","flags":{"enabled":true,"rate":85.01},"timestamps":{"created":"2022-11-25T20:11:52.125232Z","updated":"2023-04-14T20:11:52.125237Z"}}}}}}}}},"responseElements":{"instancesSet":{"items":[{"instanceId":"i-0e2bd482","currentState":{"code":16,"name":"running"},"previousState":{"code":80,"name":"stopped"},"status":{"checkTime":"2024-09-14T20:11:52.125242Z","metrics":{"cpu":13,"disk":{"used":427,"total":500,"iops":800},"network":{"in":1881,"out":3061}}}}]}},"resources":[{"ARN":"arn:aws:ec2:us-west-2::instance/i-0e2bd482","type":"AWS::EC2::Instance"}],"debugInfo":{"traceId":"7a785fce-8e60-41c8-a5a9-fd21a3435f49","flags":{"beta":false,"test":false},"extra":{"depth1":{"depth2":{"depth3":{"depth4":{"depth5":{"depth6":{"flag":true,"payload":{"numbers":[89,50,79,31,55],"nestedArray":[["mmwxnwbp","fvhttviv"],["hwqopjwa","hokrqaof"],["beboqmdc","ubyepvln"]],"timestamp":"2025-01-04T20:11:52.125273Z"}}}}}}}}}}},{"id":9,"event_time":"2023-07-05 20:11:52.125416 +00:00","event_name":"RebootInstances","aws_region":"eu-west-1","source_ip":"158.234.106.160","username":"upcbtrga","instance_id":"i-cbe23c94","principal_id":"AIDSYMQDKIEHWHN","trace_id":"f3aa6d04-b85d-4b67-8d2b-100b173e428c","raw_event":{"eventVersion":"1.08","userIdentity":{"type":"IAMUser","principalId":"AIDSYMQDKIEHWHN","arn":"arn:aws:iam::123456789012:user/upcbtrga","accountId":"123456789012","userName":"upcbtrga","sessionContext":{"attributes":{"mfaAuthenticated":"false","creationDate":"2023-12-08T20:11:52.125406Z"},"sessionIssuer":{"type":"Role","principalId":"AIDBHKAAUZPVAQC","arn":"arn:aws:iam::123456789012:role/uvkbzrgd","accountId":"123456789012","userName":"uvkbzrgd"}}},"eventTime":"2023-07-05T20:11:52.125416Z","eventSource":"ec2.amazonaws.com","eventName":"RebootInstances","awsRegion":"eu-west-1","sourceIPAddress":"158.234.106.160","requestParameters":{"instancesSet":{"items":[{"instanceId":"i-cbe23c94"}]},"dryRun":true,"tags":[{"key":"Environment","value":"Prod"},{"key":"Owner","value":"upcbtrga"},{"key":"Project","value":"iwqcosbe"},{"key":"CostCenter","value":"1219"}],"extraDetails":{"config":{"setting1":true,"setting2":"value","setting3":["hmaprdxu","pedfsjoj","jeczlgsd"],"nestedLevel1":{"nestedLevel2":{"nestedLevel3":{"nestedLevel4":{"finalLevel":{"uid":"85284dfe-bfb0-4139-8ad3-c8df1e510134","flags":{"enabled":true,"rate":16.67},"timestamps":{"created":"2023-12-15T20:11:52.125460Z","updated":"2025-03-22T20:11:52.125463Z"}}}}}}}}},"responseElements":{"instancesSet":{"items":[{"instanceId":"i-cbe23c94","currentState":{"code":16,"name":"running"},"previousState":{"code":80,"name":"stopped"},"status":{"checkTime":"2022-07-22T20:11:52.125468Z","metrics":{"cpu":46,"disk":{"used":211,"total":500,"iops":407},"network":{"in":2394,"out":3613}}}}]}},"resources":[{"ARN":"arn:aws:ec2:us-east-1::instance/i-cbe23c94","type":"AWS::EC2::Instance"}],"debugInfo":{"traceId":"f3aa6d04-b85d-4b67-8d2b-100b173e428c","flags":{"beta":true,"test":false},"extra":{"depth1":{"depth2":{"depth3":{"depth4":{"depth5":{"depth6":{"flag":true,"payload":{"numbers":[27,92,71,0,16],"nestedArray":[["icawgqiw","ckacyfsw"],["jljonpad","kvklrmql"],["blfyzudv","ykyzuaxk"]],"timestamp":"2025-01-21T20:11:52.125512Z"}}}}}}}}}}},{"id":10,"event_time":"2024-03-12 20:11:52.125621 +00:00","event_name":"RebootInstances","aws_region":"eu-west-1","source_ip":"127.243.238.200","username":"acmakble","instance_id":"i-a6799ea9","principal_id":"AIDOCDQUGNNDAKF","trace_id":"e4348eb3-6ce1-47b1-a88e-38a4cc4809ee","raw_event":{"eventVersion":"1.08","userIdentity":{"type":"IAMUser","principalId":"AIDOCDQUGNNDAKF","arn":"arn:aws:iam::123456789012:user/acmakble","accountId":"123456789012","userName":"acmakble","sessionContext":{"attributes":{"mfaAuthenticated":"true","creationDate":"2024-02-13T20:11:52.125611Z"},"sessionIssuer":{"type":"Role","principalId":"AIDWCTFPLVASVFR","arn":"arn:aws:iam::123456789012:role/xagpopcg","accountId":"123456789012","userName":"xagpopcg"}}},"eventTime":"2024-03-12T20:11:52.125621Z","eventSource":"ec2.amazonaws.com","eventName":"RebootInstances","awsRegion":"eu-west-1","sourceIPAddress":"127.243.238.200","requestParameters":{"instancesSet":{"items":[{"instanceId":"i-a6799ea9"}]},"dryRun":true,"tags":[{"key":"Environment","value":"Dev"},{"key":"Owner","value":"acmakble"},{"key":"Project","value":"furcbkco"},{"key":"CostCenter","value":"5011"}],"extraDetails":{"config":{"setting1":true,"setting2":"value","setting3":["sgelfxdq","yobiejip","rglxxiuw"],"nestedLevel1":{"nestedLevel2":{"nestedLevel3":{"nestedLevel4":{"finalLevel":{"uid":"112fcf7f-992f-4c7d-876c-09b553d8337c","flags":{"enabled":false,"rate":94.57},"timestamps":{"created":"2025-01-09T20:11:52.125662Z","updated":"2024-03-20T20:11:52.125666Z"}}}}}}}}},"responseElements":{"instancesSet":{"items":[{"instanceId":"i-a6799ea9","currentState":{"code":16,"name":"running"},"previousState":{"code":80,"name":"stopped"},"status":{"checkTime":"2023-09-07T20:11:52.125671Z","metrics":{"cpu":98,"disk":{"used":163,"total":500,"iops":897},"network":{"in":3732,"out":2598}}}}]}},"resources":[{"ARN":"arn:aws:ec2:us-east-1::instance/i-a6799ea9","type":"AWS::EC2::Instance"}],"debugInfo":{"traceId":"e4348eb3-6ce1-47b1-a88e-38a4cc4809ee","flags":{"beta":true,"test":true},"extra":{"depth1":{"depth2":{"depth3":{"depth4":{"depth5":{"depth6":{"flag":true,"payload":{"numbers":[91,11,95,82,51],"nestedArray":[["hkrfwyfu","cutkutab"],["owckbpxl","mqqskzpz"],["hesmfkvn","hzonxnni"]],"timestamp":"2023-03-25T20:11:52.125699Z"}}}}}}}}}}}];</script>
  <script type="module">// --- START OF FILE basic.js ---

import { generateSQL } from './sqlGenerator.js';

// Reactive state management
const createReactiveState = (initial) => {
    const listeners = new Set();
    const state = new Proxy(initial, {
      set(target, key, value) {
        const oldValue = target[key];
        if (oldValue !== value) {
          if (key === 'expandedPaths' && value instanceof Set && oldValue instanceof Set) {
             if (value.size !== oldValue.size || ![...value].every(item => oldValue.has(item))) {
                target[key] = value;
                listeners.forEach(fn => fn(key, value));
             }
          } else if (key === 'visibleColumns' && Array.isArray(value) && Array.isArray(oldValue)) {
              if (value.length !== oldValue.length || value.some((item, i) => item !== oldValue[i])) {
                  target[key] = value;
                  listeners.forEach(fn => fn(key, value));
              }
          }
          else {
            target[key] = value;
            listeners.forEach(fn => fn(key, value));
          }
        }
        return true;
      }
    });
    
    state.subscribe = (fn) => {
      listeners.add(fn);
      return () => listeners.delete(fn);
    };
    
    state.notify = (changedKey = null) => { 
      listeners.forEach(fn => fn(changedKey));
    };
    
    return state;
  };
  
  // Application state
  const state = createReactiveState({
    data: [],
    searchQuery: '',
    expandedPaths: new Set(),
    visibleColumns: [],
    sortBy: null,
    sortDirection: 'asc',
    showPaths: false,
    searchResults: [],
    currentSearchIndex: -1,
    showSqlModal: false,
    sqlDialect: 'snowflake', // Default to Snowflake
    editModeActive: false,
    showJsonModal: false,       // Controls visibility of the JSON edit modal
    rawJsonEditContent: '',   // Holds the string content of the JSON editor
    jsonValidationMessage: '', // Message for JSON validation status
    showPromoteKeyPopover: false, 
    promoteKeyPopoverContext: null, 
  });
  
  // Utility functions
  const escapeStringForDataAttribute = (str) => {
    if (typeof str !== 'string') return str;
    // Order is crucial: & must be escaped before " to correctly handle strings containing """ etc.
    return str.replace(/&/g, '&').replace(/"/g, '"');
  };

  const flatten = (obj, prefix = '', result = []) => {
    if (!obj || typeof obj !== 'object') {
      if (prefix) result.push({ path: prefix, value: obj });
      return result;
    }
    
    if (Array.isArray(obj)) {
      obj.forEach((item, index) => {
        const arrayPath = prefix ? `${prefix}[${index}]` : `[${index}]`;
        if (item && typeof item === 'object') {
          flatten(item, arrayPath, result);
        } else {
          result.push({ path: arrayPath, value: item });
        }
      });
    } else {
      Object.entries(obj).forEach(([key, value]) => {
        const path = prefix ? `${prefix}.${key}` : key;
        if (value && typeof value === 'object') {
          flatten(value, path, result);
        } else {
          result.push({ path, value });
        }
      });
    }
    
    return result;
  };
  
  const getValue = (obj, path) => {
    if (!obj || !path) return undefined;
    
    try {
        if (!path.includes('.') && !path.includes('[')) {
            return obj[path];
        }

        let processedPath = path.replace(/\[(\d+)\]/g, '.$1'); 
        const pathSegments = processedPath.split('.');
        
        let current = obj;
        // Regex for paths like arrayName[key="value"]
        // Key part (.+?) is non-greedy and allows most characters.
        // Value part ([^"]*) allows empty values and anything except an unescaped double quote.
        const arraySelectorRegex = /^(\w+)\[(.+?)="([^"]*)"\]$/; 

        for (const segment of pathSegments) {
            if (current == null) return undefined;

            const selectorMatch = segment.match(arraySelectorRegex);
            
            if (selectorMatch) {
                const arrayNameInSegment = selectorMatch[1];
                const keyField = selectorMatch[2]; // This is the key name, e.g., "id" or "user-id"
                const keyValue = selectorMatch[3].replace(/\\"/g, '"'); // Unescape internal quotes like \"
                
                const arrayItself = current[arrayNameInSegment];
                if (!Array.isArray(arrayItself)) return undefined; 
                
                const foundItem = arrayItself.find(item => item && typeof item === 'object' && String(item[keyField]) === keyValue);
                if (!foundItem) return undefined; 
                current = foundItem; 
            } else {
                current = current[segment];
            }
        }
        return current;
    } catch (e) {
        // console.warn("getValue error:", e, "for obj:", obj, "path:", path);
        return undefined;
    }
  };
  
  const highlightText = (text, query, isActive = false) => {
    if (text === null || text === undefined) text = ''; 
    if (!query) return String(text);
    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\<script type="module" src="basic.js"></script>')})`, 'gi');
    return String(text).replace(regex, `<span class="highlight ${isActive ? 'current' : ''}">$1</span>`);
  };
  
  const performSearch = (data, query) => {
    if (!query) return [];
    const results = [];
    data.forEach((row, rowIndex) => {
      const flattened = flatten(row); 
      flattened.forEach(({ path, value }) => {
        const strValue = String(value).toLowerCase();
        if (strValue.includes(query.toLowerCase())) {
          results.push({ rowIndex, path, value: String(value) });
        }
      });
    });
    return results;
  };
    
  const scrollToCurrentSearchResult = () => {
    const currentResultElement = document.querySelector('.highlight.current');
    if (currentResultElement) {
      currentResultElement.scrollIntoView({
        behavior: 'smooth',
        block: 'center', 
        inline: 'nearest' 
      });
    }
  };
  
  const expandToResult = (result) => {
    try {
      const pathParts = result.path.replace(/\[(\d+)\]/g, '.$1').split('.');
      let currentPath = '';
      let needsExpandedPathNotify = false;
      
      pathParts.forEach((part, index) => {
        currentPath = index === 0 ? part : `${currentPath}.${part}`;
        const objectPathForExpansion = currentPath.replace(/\.(\d+)(?=\.|$)/g, '[$1]');
        const value = getValue(state.data[result.rowIndex], objectPathForExpansion);
        if (index < pathParts.length - 1 && value && typeof value === 'object') {
          if (!state.expandedPaths.has(`${result.rowIndex}-${objectPathForExpansion}`)) {
              state.expandedPaths.add(`${result.rowIndex}-${objectPathForExpansion}`);
              needsExpandedPathNotify = true;
          }
        }
      });
      
      const finalValue = getValue(state.data[result.rowIndex], result.path);
       if (finalValue && typeof finalValue === 'object' && !state.expandedPaths.has(`${result.rowIndex}-${result.path}`)) {
           state.expandedPaths.add(`${result.rowIndex}-${result.path}`);
           needsExpandedPathNotify = true;
       }
  
      const rootColumn = result.path.split(/[.\[]/)[0];
      let columnChanged = false;
      const newVisibleColumns = [...state.visibleColumns];
  
      if (!newVisibleColumns.includes(result.path) && !newVisibleColumns.includes(rootColumn)) {
          newVisibleColumns.push(rootColumn);
          columnChanged = true;
      }
      
      if (columnChanged) {
          state.visibleColumns = newVisibleColumns; 
      }
  
      if (needsExpandedPathNotify) {
          state.notify('expandedPaths'); 
      }
      
      requestAnimationFrame(scrollToCurrentSearchResult);
  
    } catch (e) {
      console.warn('Error expanding to result:', e);
    }
  };
    
  const renderHeader = () => {
    const hiddenCount = state.searchResults.filter(result => {
        const rootColumn = result.path.split(/[.\[]/)[0];
        return !state.visibleColumns.includes(rootColumn) && !state.visibleColumns.includes(result.path);
      }
    ).length;
  
    return `
      <div class="header">
        <input 
          id="json-browser-search-box" 
          type="text" 
          class="search-box" 
          placeholder="Search JSON (Press Enter)" 
          value="${escapeStringForDataAttribute(state.searchQuery)}"
          data-action="search"
        >
        <div class="search-nav">
          <button data-action="search-prev" ${state.searchResults.length === 0 ? 'disabled' : ''}>←</button>
          <button data-action="search-next" ${state.searchResults.length === 0 ? 'disabled' : ''}>→</button>
        </div>
        <div class="controls">
          <button data-action="expand-all">Expand All</button>
          <button data-action="collapse-all">Collapse All</button>
          <button data-action="toggle-paths" class="${state.showPaths ? 'active' : ''}">
            Paths
          </button>
          <button data-action="toggle-edit-mode" class="${state.editModeActive ? 'active' : ''}">
            ${state.editModeActive ? 'Done Editing' : 'Edit Mode'}
          </button>
          <button data-action="show-sql">SQL</button>
          <button data-action="show-json">View/Edit JSON</button>
        </div>
        <div class="search-info">
          ${state.searchResults.length > 0 
            ? `${state.currentSearchIndex + 1} of ${state.searchResults.length}${hiddenCount > 0 ? `<span class="hidden-indicator">(${hiddenCount} hidden)</span>` : ''}` 
            : state.searchQuery && state.searchResults.length === 0 ? 'No matches' : `${state.data.length} rows`}
        </div>
      </div>
    `;
  };
  
  const renderCell = (value, path, rowIndex, isNestedCall = false) => {
    const isExpandable = value && typeof value === 'object';
    const expandKey = `${rowIndex}-${path}`;
    const isExpanded = state.expandedPaths.has(expandKey);
    
    let displayValue = (value === null || value === undefined) ? '' : String(value);
    if (isExpandable) {
        displayValue = Array.isArray(value) 
            ? `Array(${value.length})` 
            : `Object(${Object.keys(value).length})`;
    }
  
    let cellContent = '';
    
    const currentResult = state.searchResults[state.currentSearchIndex];
    const isCurrentMatchInCell = currentResult && 
      currentResult.rowIndex === rowIndex && 
      currentResult.path === path;
  
    if (isExpandable) {
      const nestedDivContent = isExpanded ? renderNestedObject(value, path, rowIndex) : '';
      cellContent = `
        <div class="expandable" data-action="toggle" data-path="${escapeStringForDataAttribute(path)}" data-row="${rowIndex}">
          <span class="toggle">${isExpanded ? '−' : '+'}</span>
          ${highlightText(displayValue, state.searchQuery, isCurrentMatchInCell && !isExpanded)}
        </div>
        <div class="nested ${isExpanded ? 'expanded' : ''}" data-parent-path="${escapeStringForDataAttribute(path)}" data-row-index-for-nested="${rowIndex}">
          ${nestedDivContent}
        </div>
      `;
    } else { 
      let promoteButtonHtml = '';
      const isPrimitive = value !== null && value !== undefined && typeof value !== 'object';
      if (state.editModeActive && isPrimitive && isNestedCall) { 
        promoteButtonHtml = `
          <button 
            class="promote-btn" 
            data-action="promote-value" 
            data-path-to-value="${escapeStringForDataAttribute(path)}" 
            data-row-index="${rowIndex}"
            title="Promote '${escapeStringForDataAttribute(path)}' to column"
          >+</button>`;
      }
      cellContent = highlightText(displayValue, state.searchQuery, isCurrentMatchInCell) + promoteButtonHtml;
    }
    
    const pathDisplay = state.showPaths ? `<div class="path-display">${path}</div>` : '';
    
    if (!isNestedCall) {
        return `<td class="${path === 'id' ? 'col-id' : ''}"><div>${cellContent}</div>${pathDisplay}</td>`;
    }
    return `<div>${cellContent}</div>`; 
  };
  
  const renderNestedObject = (obj, basePath, rowIndex) => {
    if (!obj || typeof obj !== 'object') {
      const currentResult = state.searchResults[state.currentSearchIndex];
      const isCurrentMatch = currentResult && 
        currentResult.rowIndex === rowIndex && 
        currentResult.path === basePath;
      
      let promoteButtonHtml = '';
      const isPrimitive = obj !== null && obj !== undefined && typeof obj !== 'object';
      if (state.editModeActive && isPrimitive) { 
        promoteButtonHtml = `
          <button 
            class="promote-btn" 
            data-action="promote-value" 
            data-path-to-value="${escapeStringForDataAttribute(basePath)}" 
            data-row-index="${rowIndex}"
            title="Promote '${escapeStringForDataAttribute(basePath)}' to column"
          >+</button>`;
      }
      return `<div>${highlightText(String(obj || ''), state.searchQuery, isCurrentMatch)}${promoteButtonHtml}</div>`;
    }
    
    let rows = '';
    let tableHtml = '';

    if (Array.isArray(obj)) {
      if (obj.length === 0) {
        return '<div><i>(empty array)</i></div>';
      }

      const firstItem = obj[0];
      let isArrayOfObjects = typeof firstItem === 'object' && firstItem !== null && !Array.isArray(firstItem);

      if (isArrayOfObjects) {
        const columnKeys = new Set();
        const sampleSize = Math.min(obj.length, 10); 
        for (let i = 0; i < sampleSize; i++) {
            if (typeof obj[i] === 'object' && obj[i] !== null && !Array.isArray(obj[i])) {
                Object.keys(obj[i]).forEach(key => columnKeys.add(key));
            }
        }
        if (columnKeys.size === 0) {
             if (obj.every(item => typeof item === 'object' && item !== null && !Array.isArray(item) && Object.keys(item).length === 0)) {
                isArrayOfObjects = false; 
             } else {
                isArrayOfObjects = false;
             }
        }
        
        if (isArrayOfObjects) { 
            const headers = Array.from(columnKeys).sort(); 

            let headerRow = '<tr>'; 
            headers.forEach(header => {
                const currentResult = state.searchResults[state.currentSearchIndex];
                const isHeaderMatch = currentResult && state.searchQuery &&
                                    header.toLowerCase().includes(state.searchQuery.toLowerCase()) &&
                                    currentResult.path.startsWith(basePath);
                headerRow += `<th>${highlightText(header, state.searchQuery, isHeaderMatch)}</th>`;
            });
            headerRow += '</tr>';

            let bodyRows = obj.map((item, index) => {
                const itemBasePath = `${basePath}[${index}]`;
                let rowCells = ``; 

                if (typeof item === 'object' && item !== null && !Array.isArray(item)) {
                    headers.forEach(key => {
                        const cellPath = `${itemBasePath}.${key}`;
                        const cellContent = renderCell(item[key], cellPath, rowIndex, true); 
                        const pathDisplay = state.showPaths ? `<div class="path-display">${cellPath}</div>` : '';
                        rowCells += `<td>${cellContent}${pathDisplay}</td>`;
                    });
                } else { 
                    const cellContent = renderCell(item, itemBasePath, rowIndex, true);
                    const pathDisplay = state.showPaths ? `<div class="path-display">${itemBasePath}</div>` : '';
                    rowCells += `<td colspan="${headers.length}">${cellContent}${pathDisplay}</td>`;
                }
                return `<tr>${rowCells}</tr>`;
            }).join('');
            tableHtml = `<table class="nested-table"><thead>${headerRow}</thead><tbody>${bodyRows}</tbody></table>`;
        }
      } 
      
      if (!isArrayOfObjects) { 
        rows = obj.map((item, index) => {
          const itemPath = `${basePath}[${index}]`;
          const itemContent = renderCell(item, itemPath, rowIndex, true); 
          const pathDisplay = state.showPaths ? `<div class="path-display">${itemPath}</div>` : '';
          return `
            <tr>
              <td class="row-number">[${index}]</td>
              <td>${itemContent}${pathDisplay}</td> 
            </tr>
          `;
        }).join('');
        tableHtml = `<table class="nested-table"><tbody>${rows}</tbody></table>`;
      }
    } else {  
        rows = Object.entries(obj).map(([key, value]) => {
          const itemPath = `${basePath}.${key}`;
          const valueContent = renderCell(value, itemPath, rowIndex, true); 
          const pathDisplay = state.showPaths ? `<div class="path-display">${itemPath}</div>` : '';
          const currentResult = state.searchResults[state.currentSearchIndex];
          const isKeyMatch = currentResult && state.searchQuery &&
            key.toLowerCase().includes(state.searchQuery.toLowerCase()) && 
            currentResult.path.startsWith(basePath);
        return `
            <tr>
              <td><div><strong>${highlightText(key, state.searchQuery, isKeyMatch)}</strong></div></td>
              <td>${valueContent}${pathDisplay}</td>
            </tr>
        `;
        }).join('');
        tableHtml = `<table class="nested-table"><tbody>${rows}</tbody></table>`;
    }
    return tableHtml;
  };
  
  const renderTable = () => {
    if (state.data.length === 0) {
      return '<div class="no-results">No data available</div>';
    }
  
    const sortedData = [...state.data];
    if (state.sortBy) {
      sortedData.sort((a, b) => {
        const aVal = getValue(a, state.sortBy);
        const bVal = getValue(b, state.sortBy);
        let comparison = 0;
        if (typeof aVal === 'number' && typeof bVal === 'number') {
            comparison = aVal - bVal;
        } else if (typeof aVal === 'string' && typeof bVal === 'string') {
            comparison = aVal.localeCompare(bVal);
        } else {
            comparison = String(aVal).localeCompare(String(bVal));
        }
        return state.sortDirection === 'asc' ? comparison : -comparison;
      });
    }
  
    return `
      <div class="json-table">
        <table>
          <thead>
            <tr>
              <th class="row-number"><div>#</div></th>
              ${state.visibleColumns.map(col => {
                let removeButtonHtml = '';
                if (state.editModeActive) {
                    removeButtonHtml = `
                        <button 
                            class="remove-col-btn-header" 
                            data-action="remove-column-header" 
                            data-column="${escapeStringForDataAttribute(col)}"
                            title="Remove column '${escapeStringForDataAttribute(col)}'"
                        >−</button>`;
                }
                return `
                <th 
                  data-action="sort" 
                  data-column="${escapeStringForDataAttribute(col)}"
                  class="${state.sortBy === col ? `sorted ${state.sortDirection}` : ''} ${col.toLowerCase() === 'id' ? 'col-id' : ''}"
                >
                  <div>
                    ${col}
                    ${removeButtonHtml}
                  </div>
                  ${state.showPaths ? `<div class="path-display">${col}</div>` : ''}
                </th>
              `}).join('')}
            </tr>
          </thead>
          <tbody>
            ${sortedData.map((row, index) => {
              const originalRowIndex = state.data.indexOf(row); 
              return `
              <tr>
                <td class="row-number"><div>${index + 1}</div></td>
                ${state.visibleColumns.map(col => 
                  renderCell(getValue(row, col), col, originalRowIndex, false) 
                ).join('')}
              </tr>
            `}).join('')}
          </tbody>
        </table>
      </div>
    `;
  };
    
  const renderSqlModal = () => {
    if (!state.showSqlModal) return '';
    return `
      <div class="modal">
        <div class="modal-content" style="width: 900px;">
          <div class="modal-header">
            <h3>Generated SQL</h3>
            <div>
              <select data-action="change-dialect" style="margin-right: 10px;">
                <option value="snowflake" ${state.sqlDialect === 'snowflake' ? 'selected' : ''}>Snowflake</option>
                <option value="postgresql" ${state.sqlDialect === 'postgresql' ? 'selected' : ''}>PostgreSQL</option>
              </select>
              <button data-action="copy-sql" style="margin-right: 10px;">Copy</button>
              <button class="close-btn" data-action="close-sql">×</button>
            </div>
          </div>
          <textarea class="sql-output" readonly>${generateSQL(state.visibleColumns, state.sqlDialect)}</textarea>
        </div>
      </div>
    `;
  };

  const renderJsonModal = () => {
    if (!state.showJsonModal) return '';
    return `
      <div class="modal">
        <div class="modal-content" style="width: 900px; height: 80vh; display: flex; flex-direction: column;">
          <div class="modal-header">
            <h3>Raw JSON Data</h3>
            <button class="close-btn" data-action="close-json">×</button>
          </div>
          <textarea 
              id="json-edit-area" 
              class="json-edit-output" 
              style="flex-grow: 1; width: 100%; resize: none; margin-bottom: 10px; font-family: 'Consolas', monospace;"
          >${state.rawJsonEditContent}</textarea>
          <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center; padding-top:10px; border-top: 1px solid #eee;">
            <div class="json-modal-actions-left">
              <button data-action="select-all-json" style="margin-right: 10px;">Select All</button>
              <button data-action="copy-json" style="margin-right: 10px;">Copy</button>
              <button data-action="clear-json" style="margin-right: 10px;">Clear</button>
              <button data-action="validate-json">Validate</button>
            </div>
            <div class="json-modal-actions-right">
                <button data-action="apply-json-changes" style="margin-left: 10px; background-color: #28a745; color:white; border:none; padding: 8px 12px; border-radius:4px; cursor:pointer;">Apply & Close</button>
            </div>
          </div>
           <span class="json-validation-status" style="font-size: 12px; min-height: 1.2em; margin-top: 5px; text-align: right;">${state.jsonValidationMessage}</span>
        </div>
      </div>
    `;
  };

  const renderPromoteKeyPopover = () => {
    if (!state.showPromoteKeyPopover || !state.promoteKeyPopoverContext) {
        return '';
    }

    const {
        targetElementRect,
        pathToArrayElement, 
        valueFieldName,     
        siblingKeysAndValues
    } = state.promoteKeyPopoverContext;

    const popoverTop = targetElementRect.bottom + window.scrollY + 5;
    const popoverLeft = targetElementRect.left + window.scrollX;

    const popoverStyle = `
        position: absolute;
        top: ${popoverTop}px;
        left: ${popoverLeft}px;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px;
        z-index: 1050; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        font-size: 0.9em;
        min-width: 200px;
    `;

    const arrayName = pathToArrayElement.substring(0, pathToArrayElement.lastIndexOf('['));
    const itemIdentifierInArray = pathToArrayElement.substring(pathToArrayElement.lastIndexOf('['));


    let content = `<div style="margin-bottom: 8px; font-weight: bold;">Promote field: <code>${valueFieldName}</code></div>`;
    content += `<div style="margin-bottom: 8px; font-size: 0.9em;">From item in <code>${arrayName}</code>. Identify this item by:</div>`;
    content += '<ul style="list-style: none; padding: 0; margin: 0;">';

    siblingKeysAndValues.forEach(skv => {
        let displayValue = String(skv.value);
        if (displayValue.length > 25) { 
            displayValue = displayValue.substring(0, 22) + "...";
        }
        content += `
            <li style="margin-bottom: 5px;">
                <button class="promote-popover-btn" data-action="confirm-promote-with-key" data-selected-key="${escapeStringForDataAttribute(skv.key)}">
                    ${skv.key}: "${escapeStringForDataAttribute(displayValue)}"
                </button>
            </li>`;
    });

    content += `
        <li style="margin-bottom: 5px;">
            <button class="promote-popover-btn" data-action="confirm-promote-with-key" data-selected-key="INDEX">
                Original position (<code>${itemIdentifierInArray}</code>)
            </button>
        </li>
    `;
    content += `
        <li style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 8px;">
            <button class="promote-popover-btn promote-popover-cancel-btn" data-action="cancel-promote-popover">Cancel</button>
        </li>
    `;
    content += '</ul>';

    return `<div class="promote-key-popover" style="${popoverStyle}">${content}</div>`;
  };
  
  const render = () => {
    const appElement = document.getElementById('app');
    if (!appElement) return;
    
    const activeElement = document.activeElement;
    let activeElementId = activeElement ? activeElement.id : null;
    let selectionStart, selectionEnd;

    if (activeElement && (activeElement.id === 'json-browser-search-box' || activeElement.id === 'json-edit-area')) {
        selectionStart = activeElement.selectionStart;
        selectionEnd = activeElement.selectionEnd;
    }
  
    const jsonTableElement = appElement.querySelector('.json-table');
    let mainScrollLeft = 0;
    let mainScrollTop = 0;
  
    if (jsonTableElement) {
        mainScrollLeft = jsonTableElement.scrollLeft; 
        mainScrollTop = jsonTableElement.scrollTop;
    }
    
    appElement.innerHTML = `
      ${renderHeader()}
      ${renderTable()}
      ${renderSqlModal()} 
      ${renderJsonModal()}
      ${renderPromoteKeyPopover()}
    `;
  
    const newJsonTableElement = appElement.querySelector('.json-table');
    if (newJsonTableElement) {
        if (mainScrollTop !== undefined) newJsonTableElement.scrollTop = mainScrollTop;
        if (mainScrollLeft !== undefined) newJsonTableElement.scrollLeft = mainScrollLeft; 
    }
  
    if (activeElementId) {
        const newActiveElement = document.getElementById(activeElementId);
        if (newActiveElement) {
            newActiveElement.focus();
            if ((activeElementId === 'json-browser-search-box' || activeElementId === 'json-edit-area') && 
                selectionStart !== undefined && selectionEnd !== undefined) {
                try {
                    newActiveElement.setSelectionRange(selectionStart, selectionEnd);
                } catch (ex) { /* ignore */ }
            }
        }
    }
    if (state.showJsonModal) {
        const jsonEditArea = document.getElementById('json-edit-area');
        if (jsonEditArea && jsonEditArea.value !== state.rawJsonEditContent) {
            jsonEditArea.value = state.rawJsonEditContent; // Keep textarea synced with state
            // Restore selection if this specific textarea was active
            if (activeElementId === 'json-edit-area' && newActiveElement === jsonEditArea) {
                 try {
                    jsonEditArea.setSelectionRange(selectionStart, selectionEnd);
                } catch (ex) {/* ignore */}
            }
        }
    }
  };
  
  const handleEvent = (e) => {
    const eventTarget = e.target; 
    
    if (state.showPromoteKeyPopover) {
        const popoverElement = document.querySelector('.promote-key-popover');
        const clickedPromoteButton = eventTarget.closest('[data-action="promote-value"]');
        const clickedInsidePopover = popoverElement && popoverElement.contains(eventTarget);

        if (!clickedInsidePopover && !clickedPromoteButton) {
            state.showPromoteKeyPopover = false;
            state.promoteKeyPopoverContext = null;
        }
    }

    let target = eventTarget; 
    let action = target.dataset.action;
  
    if (!action && target.closest('[data-action]')) {
        target = target.closest('[data-action]');
        action = target.dataset.action;
    }
    if (!action) return; 
  
    // Note: target.dataset values are automatically unescaped by the browser
    const { path, row, column } = target.dataset; 
    
    switch (action) {
      case 'search': 
        if (state.searchQuery !== target.value) { 
          state.searchQuery = target.value;
          if (state.searchQuery === '') {
              state.searchResults = [];
              state.currentSearchIndex = -1;
          }
        }
        break;
        
      case 'search-next':
        if (state.searchResults.length > 0) {
          state.currentSearchIndex = (state.currentSearchIndex + 1) % state.searchResults.length;
          const result = state.searchResults[state.currentSearchIndex];
          expandToResult(result); 
        }
        break;
        
      case 'search-prev':
        if (state.searchResults.length > 0) {
          state.currentSearchIndex = (state.currentSearchIndex - 1 + state.searchResults.length) % state.searchResults.length;
          const result = state.searchResults[state.currentSearchIndex];
          expandToResult(result); 
        }
        break;
        
      case 'toggle':
        const expandKey = `${row}-${path}`; // path from dataset is already unescaped
        if (state.expandedPaths.has(expandKey)) {
          state.expandedPaths.delete(expandKey);
        } else {
          state.expandedPaths.add(expandKey);
        }
        state.notify('expandedPaths'); 
        break;
        
      case 'expand-all':
        state.data.forEach((rowData, rowIndex) => {
          const flattened = flatten(rowData);
          flattened.forEach(({ path: itemPath }) => { 
            const value = getValue(rowData, itemPath);
            if (value && typeof value === 'object') {
              state.expandedPaths.add(`${rowIndex}-${itemPath}`);
            }
          });
        });
        state.notify('expandedPaths');
        break;
        
      case 'collapse-all':
        state.expandedPaths.clear();
        state.notify('expandedPaths');
        break;
        
      case 'toggle-paths':
        state.showPaths = !state.showPaths;
        break;

      case 'toggle-edit-mode':
        state.editModeActive = !state.editModeActive;
        if (!state.editModeActive && state.showPromoteKeyPopover) {
            state.showPromoteKeyPopover = false;
            state.promoteKeyPopoverContext = null;
        }
        break;

      case 'promote-value':
        const pathClicked = target.dataset.pathToValue; // path from dataset is already unescaped
        const rowIndexForContext = parseInt(target.dataset.rowIndex);
        const rowData = state.data[rowIndexForContext]; 

        const lastDotIndex = pathClicked.lastIndexOf('.');
        
        if (lastDotIndex === -1) { 
            if (!state.visibleColumns.includes(pathClicked)) {
                state.visibleColumns = [...state.visibleColumns, pathClicked];
            }
            if (state.showPromoteKeyPopover) { 
                state.showPromoteKeyPopover = false;
                state.promoteKeyPopoverContext = null;
            }
            break; 
        }

        const parentObjectPath = pathClicked.substring(0, lastDotIndex); 
        const fieldName = pathClicked.substring(lastDotIndex + 1);      

        const arrayElementMatch = parentObjectPath.match(/^(.*)\[(\d+)\]$/); 

        if (arrayElementMatch) { 
            const pathToArrayElement = parentObjectPath; 
            const objectInArray = getValue(rowData, pathToArrayElement);

            if (objectInArray && typeof objectInArray === 'object' && !Array.isArray(objectInArray)) {
                const siblingKeysAndValues = [];
                for (const key in objectInArray) {
                    const val = objectInArray[key];
                    if (typeof val === 'string' || typeof val === 'number' || typeof val === 'boolean') {
                        siblingKeysAndValues.push({ key, value: val });
                    }
                }

                if (siblingKeysAndValues.length > 0) {
                    state.promoteKeyPopoverContext = {
                        rowIndex: rowIndexForContext,
                        originalPathToValue: pathClicked,    
                        pathToArrayElement: pathToArrayElement, 
                        valueFieldName: fieldName,           
                        targetElementRect: target.getBoundingClientRect(),
                        siblingKeysAndValues
                    };
                    state.showPromoteKeyPopover = true;
                    return; 
                }
            }
        }
        
        if (!state.visibleColumns.includes(pathClicked)) {
            state.visibleColumns = [...state.visibleColumns, pathClicked];
        }
        if (state.showPromoteKeyPopover) { 
            state.showPromoteKeyPopover = false;
            state.promoteKeyPopoverContext = null;
        }
        break;

      case 'confirm-promote-with-key':
        if (!state.promoteKeyPopoverContext) break;

        const {
            rowIndex,
            originalPathToValue, 
            pathToArrayElement,  
            valueFieldName,      
        } = state.promoteKeyPopoverContext;
        
        const selectedKeyForId = target.dataset.selectedKey; // key from dataset is already unescaped
        const rowDataForPromotion = state.data[rowIndex];
        let pathToPromote;

        if (selectedKeyForId === 'INDEX') {
            pathToPromote = originalPathToValue; 
        } else {
            const arrayBasePath = pathToArrayElement.substring(0, pathToArrayElement.lastIndexOf('[')); 
            const objectInArray = getValue(rowDataForPromotion, pathToArrayElement); 
            
            if (objectInArray && typeof objectInArray === 'object' && objectInArray.hasOwnProperty(selectedKeyForId)) {
                const identifyingKeyValue = String(objectInArray[selectedKeyForId]);
                // Escape quotes within the value for the path string itself
                const safeIdentifyingKeyValue = identifyingKeyValue.replace(/"/g, '\\"'); 
                pathToPromote = `${arrayBasePath}[${selectedKeyForId}="${safeIdentifyingKeyValue}"].${valueFieldName}`;
            } else {
                pathToPromote = originalPathToValue;
                console.warn("Could not find selected key for promotion, falling back to index path.");
            }
        }

        if (!state.visibleColumns.includes(pathToPromote)) {
            state.visibleColumns = [...state.visibleColumns, pathToPromote];
        }

        state.showPromoteKeyPopover = false;
        state.promoteKeyPopoverContext = null;
        break;

      case 'cancel-promote-popover':
        state.showPromoteKeyPopover = false;
        state.promoteKeyPopoverContext = null;
        break;
        
      case 'sort':
        const sortColumn = column; // column from dataset is already unescaped
        if (state.sortBy === sortColumn) {
          state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          state.sortBy = sortColumn;
          state.sortDirection = 'asc';
        }
        break;
              
      case 'remove-column-header': 
        const colToRemove = column; // column from dataset is already unescaped
        state.visibleColumns = state.visibleColumns.filter(c => c !== colToRemove);
        if (state.sortBy === colToRemove) {
            state.sortBy = null; 
        }
        break;
        
      case 'show-sql':
        state.showSqlModal = true;
        break;
        
      case 'close-sql':
        state.showSqlModal = false;
        break;
        
      case 'change-dialect':
        state.sqlDialect = target.value; 
        break;
        
      case 'copy-sql':
        { 
          const sqlOutputElement = document.querySelector('.sql-output');
          if (sqlOutputElement) {
            navigator.clipboard.writeText(sqlOutputElement.value).then(() => {
              target.textContent = 'Copied!'; 
              setTimeout(() => target.textContent = 'Copy', 2000);
            }).catch(err => {
                console.error('Failed to copy SQL: ', err);
                target.textContent = 'Failed!';
                setTimeout(() => target.textContent = 'Copy', 2000);
            });
          }
        }
        break;

      case 'show-json':
        state.rawJsonEditContent = JSON.stringify(state.data, null, 2);
        state.jsonValidationMessage = ''; 
        state.showJsonModal = true;
        break;
        
      case 'close-json':
        state.showJsonModal = false;
        state.jsonValidationMessage = ''; 
        break;
        
      case 'clear-json':
        state.rawJsonEditContent = '';
        // Also update the textarea if it's visible
        const jsonEditAreaForClear = document.getElementById('json-edit-area');
        if (jsonEditAreaForClear) jsonEditAreaForClear.value = '';
        state.jsonValidationMessage = '';
        break;
      
      case 'select-all-json':
        {
            const jsonEditArea = document.getElementById('json-edit-area');
            if (jsonEditArea) {
                jsonEditArea.focus();
                jsonEditArea.select();
            }
        }
        break;

      case 'copy-json':
        {
            const jsonEditArea = document.getElementById('json-edit-area');
            if (jsonEditArea) {
                navigator.clipboard.writeText(jsonEditArea.value).then(() => {
                    state.jsonValidationMessage = '<span style="color: green;">Copied to clipboard!</span>';
                }).catch(err => {
                    console.error('Failed to copy JSON: ', err);
                    state.jsonValidationMessage = '<span style="color: red;">Failed to copy.</span>';
                });
            }
        }
        break;

      case 'validate-json':
        try {
          const jsonEditArea = document.getElementById('json-edit-area');
          const currentText = jsonEditArea ? jsonEditArea.value : state.rawJsonEditContent;

          const parsedJson = JSON.parse(currentText);
          // Prettify and update state.rawJsonEditContent, which will re-render textarea
          state.rawJsonEditContent = JSON.stringify(parsedJson, null, 2); 
          state.jsonValidationMessage = '<span style="color: green;">JSON is valid.</span>';
        } catch (err) {
          state.jsonValidationMessage = `<span style="color: red;">Invalid JSON: ${err.message}</span>`;
        }
        break;

      case 'apply-json-changes':
        try {
          const jsonEditArea = document.getElementById('json-edit-area');
          const currentText = jsonEditArea ? jsonEditArea.value : state.rawJsonEditContent;

          const parsedJson = JSON.parse(currentText);
          if (Array.isArray(parsedJson)) { 
            state.data = parsedJson; 
            state.showJsonModal = false;
            state.jsonValidationMessage = '';

            if (state.data.length > 0 && typeof state.data[0] === 'object' && state.data[0] !== null) {
                state.visibleColumns = Object.keys(state.data[0]);
            } else {
                state.visibleColumns = [];
            }
            state.searchQuery = '';
            state.searchResults = [];
            state.currentSearchIndex = -1;
            state.expandedPaths.clear(); 
            state.notify('expandedPaths'); 
            state.sortBy = null;
            
          } else {
            state.jsonValidationMessage = '<span style="color: red;">Invalid format: Root must be a JSON array.</span>';
          }
        } catch (err) {
          state.jsonValidationMessage = `<span style="color: red;">Cannot apply: Invalid JSON. ${err.message}</span>`;
        }
        break;
    }
  };
  
  const handleKeyboard = (e) => {
    const searchBoxFocused = e.target.matches('.search-box') || e.target.id === 'json-browser-search-box';
    const jsonEditAreaFocused = e.target.id === 'json-edit-area';
  
    if (searchBoxFocused) {
      if (e.key === 'Enter') {
        e.preventDefault(); 
        if (state.searchQuery !== e.target.value) {
             state.searchQuery = e.target.value;
        }
        
        if (state.searchQuery.trim() === '') {
            state.searchResults = [];
            state.currentSearchIndex = -1;
            return;
        }
  
        state.searchResults = performSearch(state.data, state.searchQuery);
        state.currentSearchIndex = state.searchResults.length > 0 ? 0 : -1;
        
        if (state.searchResults.length > 0) {
            expandToResult(state.searchResults[state.currentSearchIndex]); 
        } else {
            // Trigger render to show "No matches" if applicable
            // This is handled by state.searchQuery or state.searchResults changing
        }
      } else if (e.key === 'Escape') {
        e.preventDefault(); 
        state.searchQuery = '';
        e.target.value = ''; 
        state.searchResults = [];
        state.currentSearchIndex = -1;
      }
    }
    
    if (e.key === 'Escape') {
        let handledByEscape = false;
        if (state.showPromoteKeyPopover) {
            state.showPromoteKeyPopover = false;
            state.promoteKeyPopoverContext = null;
            handledByEscape = true;
        } else if (state.showSqlModal) {
            state.showSqlModal = false;
            handledByEscape = true;
        } else if (state.showJsonModal) { 
            state.showJsonModal = false;
            state.jsonValidationMessage = '';
            handledByEscape = true;
        } else if (state.editModeActive && !searchBoxFocused && !jsonEditAreaFocused) { 
            state.editModeActive = false;
            handledByEscape = true;
        }
        // If handled, state change will trigger re-render.
        // No explicit render() call needed here.
    }
  };

  const init = async () => {
    try {
      if (typeof jsonData !== 'undefined' && Array.isArray(jsonData)) {
          state.data = jsonData;
      } else {
          console.warn("`jsonData` not found globally. Falling back to 'samplejson.json'.");
          const response = await fetch('samplejson.json'); 
          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status} while fetching samplejson.json`);
          }
          let sampleData = await response.json();
          state.data = Array.isArray(sampleData) ? sampleData : [sampleData]; 
      }
      
      if (state.data.length > 0 && typeof state.data[0] === 'object' && state.data[0] !== null) {
          state.visibleColumns = Object.keys(state.data[0]);
      } else {
          state.visibleColumns = [];
      }
      
      state.subscribe((changedKey) => {
          // console.log('State changed:', changedKey); 
          render();
      }); 
      
      document.addEventListener('click', handleEvent);

      document.addEventListener('input', (e) => { 
        const target = e.target;
        
        if (target.id === 'json-browser-search-box') {
             if (target.value === '' && state.searchQuery !== '') { // Only update state if value becomes empty
                state.searchQuery = ''; 
                state.searchResults = [];
                state.currentSearchIndex = -1;
            } else if (target.value !== '' && target.value !== state.searchQuery) {
                // To support live updates as user types IF we want search-as-you-type later.
                // For now, search is on Enter/button click. But keep searchQuery state somewhat synced.
                // state.searchQuery = target.value; // This would trigger search on every keystroke if not careful
            }
        } else if (target.id === 'json-edit-area') { 
            // Update state directly to ensure consistency, especially if render is triggered elsewhere.
            if (state.rawJsonEditContent !== target.value) {
                state.rawJsonEditContent = target.value;
            }
            // Clear validation message on typing
            if (state.jsonValidationMessage && (state.jsonValidationMessage.includes('red') || state.jsonValidationMessage.includes('green'))) {
                state.jsonValidationMessage = ''; 
            }
        }
      });

      document.addEventListener('change', (e) => { 
        const target = e.target;
        if (target && target.dataset && target.dataset.action === "change-dialect") {
            handleEvent(e); // Let general handler do its job.
        }
      });
      document.addEventListener('keydown', handleKeyboard);
      
      render(); // Initial render
      
    } catch (error) {
      console.error('Initialization error:', error);
      const appElement = document.getElementById('app');
      if (appElement) {
        appElement.innerHTML = `
            <div class="no-results" style="color: red; border: 1px solid red; padding: 20px;">
                Error loading or initializing data: ${error.message}<br>
                Please check the console for more details. Ensure 'samplejson.json' is accessible if global 'jsonData' is not provided.
            </div>`;
      }
    }
  };
  
  if (typeof jsonData === 'undefined') {
      document.addEventListener('DOMContentLoaded', init);
  } else {
      init(); 
  }
// --- END OF FILE basic.js ---</script>
</body>
</html>